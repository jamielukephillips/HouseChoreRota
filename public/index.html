<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Schedule</title>
    <link rel="stylesheet" href="/assets/styles.css">
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>
<h1>Task Schedule</h1>
<table id="taskTable">
    <thead>
    <tr>
        <th>Week Commencing</th>
        <th>Kitchen & Living Room</th>
        <th>Conservatory, Laundry & Hallways/Stairs</th>
        <th>Garden</th>
    </tr>
    </thead>
    <tbody>
    <!-- Table rows will be inserted here by JavaScript -->
    </tbody>
</table>
<script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDSQldYHWuR_XHxECwKS-rnfkcq7SRber8",
        authDomain: "h0useh0ld-ch0r3z.firebaseapp.com",
        projectId: "h0useh0ld-ch0r3z",
        storageBucket: "h0useh0ld-ch0r3z.appspot.com",
        messagingSenderId: "771768796151",
        appId: "1:771768796151:web:4e54e1c6a78d4275dfa4f2"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Initialize Firestore
    const db = firebase.firestore();
    const names = ["Elsie", "Hilary", "Jamie", "Liam"];
    const numWeeks = 12;

    // Get today's date and format as DD-MMM
    function formatDate(date) {
        const options = { day: '2-digit', month: 'short' };
        return date.toLocaleDateString('en-GB', options);
    }

    function getMondayOfCurrentWeek() {
        const today = new Date();
        const day = today.getDay();
        const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
        return new Date(today.setDate(diff));
    }

    function getNextWeeks(startDate, numWeeks) {
        const weeks = [];
        for (let i = 0; i < numWeeks; i++) {
            const weekStart = new Date(startDate);
            weekStart.setDate(startDate.getDate() + i * 7);
            weeks.push(formatDate(weekStart));
        }
        return weeks;
    }

    function getClassForName(name) {
        switch (name) {
            case "Elsie": return "yellow";
            case "Jamie": return "green";
            case "Liam": return "orange";
            case "Hilary": return "purple";
            default: return "";
        }
    }

    function applyColorCoding() {
        const cells = document.querySelectorAll('td');
        cells.forEach(cell => {
            const text = cell.textContent.trim();
            const className = getClassForName(text);
            cell.className = className;
        });
    }

    function shiftRowsAndPopulateTable() {
        const startDate = getMondayOfCurrentWeek();
        const weeks = getNextWeeks(startDate, numWeeks + 1); // Get weeks including one extra for new row

        // Remove the oldest week's data from Firestore
        db.collection("tasks").doc(weeks[0]).delete().then(() => {
            console.log("Deleted the oldest week's data");

            // Now, shift the tasks manually
            shiftTasksAndPopulate(weeks);

        }).catch((error) => {
            console.error("Error removing document: ", error);
        });
    }

    function shiftTasksAndPopulate(weeks) {
        db.collection("tasks").get().then((querySnapshot) => {
            let tasks = querySnapshot.docs.map(doc => ({ ...doc.data(), week: doc.id }));

            // Sort the tasks by week to ensure correct order
            tasks.sort((a, b) => {
                const weekA = weeks.indexOf(a.week);
                const weekB = weeks.indexOf(b.week);
                return weekA - weekB;
            });

            // Determine the new tasks for the last week
            const newTask1Index = (tasks.length - 1) % names.length;
            const newTask2Index = (tasks.length) % names.length;
            const newWeek = weeks[weeks.length - 1];

            // Only assign the garden task every 4 weeks
            const newGardenIndex = (tasks.length + 1) % names.length;
            const gardenTask = (tasks.length + 1) % 4 === 0 ? names[newGardenIndex] : "";

            // Add a new task for the new week
            const newTask = {
                task1: names[newTask1Index] || "",
                task2: names[newTask2Index] || "",
                gardenTask: gardenTask || "",
                week: newWeek
            };

            tasks.push(newTask);

            // Update Firestore with the new tasks
            tasks.forEach(task => {
                db.collection("tasks").doc(task.week).set(task, { merge: true })
                    .then(() => {
                        console.log(`Tasks updated for week ${task.week}`);
                    })
                    .catch((error) => {
                        console.error("Error updating tasks: ", error);
                    });
            });

            // Populate the table
            populateTable(weeks.slice(1)); // Exclude the first week, as it's now removed

        }).catch((error) => {
            console.error("Error getting documents: ", error);
        });
    }

    function populateTable(weeks) {
        const tbody = document.querySelector('#taskTable tbody');
        tbody.innerHTML = ''; // Clear existing rows

        db.collection("tasks").get().then((querySnapshot) => {
            const tasks = querySnapshot.docs.map(doc => ({ ...doc.data(), week: doc.id }));

            // Sort tasks by their week
            tasks.sort((a, b) => {
                return weeks.indexOf(a.week) - weeks.indexOf(b.week);
            });

            // Log to verify the order and contents of tasks
            console.log("Tasks after sorting:", tasks);

            for (let i = 0; i < weeks.length; i++) {
                const week = weeks[i];
                const task = tasks.find(t => t.week === week) || {};
                const row = `<tr>
                        <td>${week}</td>
                        <td contenteditable="true" data-week="${week}" data-task="1">${task.task1 || ""}</td>
                        <td contenteditable="true" data-week="${week}" data-task="2">${task.task2 || ""}</td>
                        <td contenteditable="true" data-week="${week}" data-task="3">${task.gardenTask || ""}</td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            }
            applyColorCoding();
            attachEventListeners();
        }).catch((error) => {
            console.error("Error getting documents: ", error);
        });
    }

    function attachEventListeners() {
        const editableCells = document.querySelectorAll('td[contenteditable]');
        editableCells.forEach(cell => {
            cell.addEventListener('input', (event) => {
                const cell = event.target;
                const week = cell.getAttribute('data-week');
                const taskType = cell.getAttribute('data-task');
                const newValue = cell.textContent.trim();
                const updateData = {};
                if (taskType === "1") updateData.task1 = newValue;
                if (taskType === "2") updateData.task2 = newValue;
                if (taskType === "3") updateData.gardenTask = newValue;
                db.collection("tasks").doc(week).set(updateData, { merge: true })
                    .then(() => {
                        console.log(`Document successfully updated for week ${week}`);
                    })
                    .catch((error) => {
                        console.error("Error updating document: ", error);
                    });
                applyColorCoding();
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        shiftRowsAndPopulateTable();
    });
</script>
</body>
</html>
